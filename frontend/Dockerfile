# =========================================================
# 1. BUILD STAGE: ì •ì  íŒŒì¼ ë¹Œë“œ
# =========================================================
FROM node:20-alpine AS builder

WORKDIR /usr/src/app

# 3. ì¢…ì†ì„± ë³µì‚¬ ë° ì„¤ì¹˜ (ìºì‹± ìµœì í™”)
COPY package*.json ./
# ğŸš¨ 'postinstall' ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¬´ì‹œí•˜ê³  ì˜ì¡´ì„± ì„¤ì¹˜
RUN npm install --ignore-scripts

# 4. ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY . .

# 5. í”„ë¡œë•ì…˜ ë¹Œë“œ ì‹¤í–‰
# 'npm run build'ëŠ” 'vite build'ë¥¼ ì‹¤í–‰í•˜ë©°, ì´ ë‹¨ê³„ì—ì„œ ì •ì  íŒŒì¼(/dist)ì´ ìƒì„±ë©ë‹ˆë‹¤.
RUN npm run build

# =========================================================
# 2. SERVE STAGE: ë¹Œë“œëœ íŒŒì¼ì„ ì„œë¹™ (ê²½ëŸ‰í™”)
# =========================================================
# ì •ì  íŒŒì¼ì„ ì„œë¹™í•  ê²½ëŸ‰ Node.js ì´ë¯¸ì§€ ì‚¬ìš©
FROM node:20-alpine

WORKDIR /usr/src/app

# 6. ì •ì  íŒŒì¼ ì„œë¹™ì„ ìœ„í•œ http-server ì„¤ì¹˜
# serve ë˜ëŠ” http-server ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì—¬ ì„¤ì¹˜í•©ë‹ˆë‹¤.
RUN npm install -g http-server

# 7. ë¹Œë“œ ê²°ê³¼ë¬¼ ë³µì‚¬
# ë¹Œë“œ ìŠ¤í…Œì´ì§€ì—ì„œ ìƒì„±ëœ ì •ì  íŒŒì¼(dist í´ë”)ë§Œ ë³µì‚¬í•©ë‹ˆë‹¤.
COPY --from=builder /usr/src/app/dist ./dist

# 8. ì»¨í…Œì´ë„ˆ ì‹œì‘ ëª…ë ¹ (http-serverë¥¼ ì‚¬ìš©í•˜ì—¬ ì •ì  íŒŒì¼ ì„œë¹™)
# ì»¨í…Œì´ë„ˆ í¬íŠ¸ 3000ë²ˆì—ì„œ dist í´ë”ë¥¼ ì„œë¹™í•©ë‹ˆë‹¤.
EXPOSE 3000
CMD ["http-server", "dist", "-p", "3000"]
